name: "Release Publication"

on:
  release:
    types: [released]

permissions:
  id-token: write
  contents: write
  packages: write
  pages: write

jobs:
  publish:
    name: ðŸš€ Publish to NPM
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: prod
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - uses: ./.github/actions/setup-node-pnpm
      - run: npm -v && node -v && npm i -g npm@latest
      - name: ðŸ”§ Verify Release Tag
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          if [[ "$TAG_NAME" == *"-pre" ]]; then
            echo "âŒ This appears to be a pre-release tag ($TAG_NAME). This workflow should only run on full releases."
            exit 1
          fi
          echo "âœ… Publishing release for tag: $TAG_NAME"

      - name: ðŸ“¦ Create Package Tarball
        run: |
          # Extract version from tag (remove 'v' prefix if present)
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"

          pnpm build:vendor
          echo "checking vendor contents:"
          ls -la vendor || true
          find vendor -maxdepth 3 -type f -print || true

          echo "== symlinks under vendor =="
          find vendor -type l -ls || true

          echo "== vendor listing (shows -> targets) =="
          ls -la vendor || true
          ls -la vendor/* || true

          ls -la vendor || true
          find vendor -maxdepth 3 -type f -print || true

          echo "Creating package tarball for version: $VERSION"

          # Create the package tarball
          pnpm pack

      - name: ðŸš€ Publish to NPM
        run: |
          # Extract version from tag (remove 'v' prefix if present)
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"

          echo "Publishing version: $VERSION"

          # Find the packed tarball
          TARBALL=$(ls janus-*.tgz | head -1)
          echo "Publishing tarball: $TARBALL"

          # Publish the tarball to NPM using OIDC authentication
          npm publish "$TARBALL" --access public --provenance
